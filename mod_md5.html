<!-- $Id: mod_md5.html,v 1.2 2006/12/14 01:59:16 tj Exp tj $ -->
<!-- $Source: /home/tj/proftpd/modules/doc/RCS/mod_md5.html,v $ -->

<html>
<head>
<title>ProFTPD module mod_md5</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<h2><b>ProFTPD module <code>mod_md5</code></b></h2>
</center>
<hr><br>

<p>
When a file is uploaded into a specially configured directory, a MD5 digest of
the uploaded file is automatically calculated.  This MD5 digest is written
automatically to a file in the same directory.  For example, if a file called
&quot;file.txt&quot; is uploaded into a
<code><a href="#MD5Path">MD5Path</a></code> directory, then a file called
&quot;file.txt.md5&quot; will also automatically be written.  The contents of
this <code>.md5</code> file are identical to the output of the common
<code>md5sum</code> command.

<p>
This <code>.md5</code> file is useful for large uploads, where the sender
wants to be certain that the file was received by the server intact.  By
comparing the autogenerated <code>.md5</code> file's MD5 digest with an MD5
digest of the large file calculated by the client before sending, the sender
can verify the upload.

<p>
The <code>mod_md5</code> module is contained in the <code>mod_md5.c</code>
file for ProFTPD 1.3.<i>x</i>, found
<a href="http://www.castaglia.org/">here</a>, and is not compiled by default.
Installation instructions are discussed <a href="#Installation">here</a>.

<p>
The most current version of <code>mod_md5</code> can be found at:
<pre>
  <a href="http://www.castaglia.org/proftpd/">http://www.castaglia.org/proftpd/</a>
</pre>

<h2>Author</h2>
<p>
Please contact TJ Saunders &lt;tj <i>at</i> castaglia.org&gt; with any
questions, concerns, or suggestions regarding this module.

<h2>Thanks</h2>
<p>
<i>2001-12-18</i>: Thanks to Bill Fenner for the initial ideas for this module
<p>
<i>2002-08-08</i>: Thanks to Jonas Jensen for noting the problems when using <code>SITE MD5</code> in a <code>DefaultRoot</code> login, and on non-regular files (<i>e.g.</i> directories).

<h2>Directives</h2>
<ul>
  <li><a href="#MD5Engine">MD5Engine</a>
  <li><a href="#MD5Path">MD5Path</a>
</ul>

<p>
<h2><code>SITE</code> Commands</h2>
<ul>
  <li><a href="#SITE_MD5">SITE MD5</a>
</ul>

<hr>
<h2><a name="MD5Engine">MD5Engine</a></h2>
<strong>Syntax:</strong> MD5Engine <em>on|off</em><br>
<strong>Default:</strong> off<br>
<strong>Context:</strong> server config, <code>&lt;VirtualHost&gt;</code>, <code>&lt;Global&gt;</code><br>
<strong>Module:</strong> mod_md5<br>
<strong>Compatibility:</strong> 1.3.1rc1 and later

<p>
The <code>MD5Engine</code> directive enables or disables the module's
runtime MD5 engine.  If it is set to <em>off</em> this module does no
MD5 processing at all. Use this directive to disable the module instead of
commenting out all <code>mod_md5</code> directives.

<p>
<hr>
<h2><a name="MD5Path">MD5Path</a></h2>
<strong>Syntax:</strong> MD5Path <em>path</em><br>
<strong>Default:</strong> None<br>
<strong>Context:</strong> server config, <code>&lt;VirtualHost&gt;</code>, <code>&lt;Global&gt;</code>, <code>&lt;Anonymous&gt;</code><br>
<strong>Module:</strong> mod_md5<br>
<strong>Compatibility:</strong> 1.3.1rc1 and later

<p>
The <code>MD5Path</code> directive specifies a <em>path</em> to a directory.
Files uploaded to that directory (and its subdirectories) will automatically
have MD5 digests calculated and printed to a <i>file</i><code>.md5</code> file.
Multiple such directories can be configured by using mulitple
<code>MD5Path</code> directives.

<p>
<b>Note</b> that if the given <em>path</em> starts with a <code>!</code>,
<code>mod_md5</code> will treat the directory normally, and not generate
<code>.md5</code> files in that directory.  This is primarily useful for
disabling <code>.md5</code> generation in directories whose parent directories
may be <code>MD5Path</code> directories.

<p>
Example:
<pre>
  # A path can use ~ notation
  MD5Path ~/public_ftp/md5

  # Calculate digests in the normal upload directory
  MD5Path /path/to/upload/dir

  # Disable generation of .md5 files in a subdirectory of the upload directory
  MD5Path !/path/to/upload/dir/subdir
</pre>

<p>
<hr>
<h2><a name="SITE_MD5">SITE MD5</a></h2>
This <code>SITE</code> command accepts a single parameter, the path to the file
of which to obtain the MD5 digest, and can only be used once the client has
successfully logged in.  When allowing this command to be used, it is best
to limit its use to trusted clients, <i>e.g.</i>:
<pre>
  &lt;Limit SITE_MD5&gt;
    Allow ...
    DenyAll
  &lt;/Limit&gt;
</pre>
for calculating the sum for large files can be CPU-intensive.

<p>
Example:
<pre>
ftp&gt; quote SITE MD5 HelloWorld.txt
200-9af2f8218b150c351ad802c6f3d66abe    HelloWorld.txt
200 Please contact root@familiar.castaglia.org if this digest is inaccurate
</pre>

<p>
Use of this <code>SITE</code> can be controlled via <code>&lt;Limit&gt;</code>,
<i>e.g.</i>:
<pre>
  &lt;Limit SITE_MD5&gt;
    AllowUser stan
    DenyAll
  &lt;/Limit&gt;
</pre>

<p>
<hr>
<h2><a name="Installation">Installation</a></h2>
After unpacking and patching the latest proftpd-1.3 source code, copy the
<code>mod_md5.c</code> file into:
<pre>
  <i>proftpd-dir</i>/contrib/
</pre>
Then follow the normal steps for using third-party modules in proftpd:
<pre>
  ./configure --with-modules=mod_md5
  make
  make install
</pre>

<p>
<hr>
<h2><a name="Usage">Usage</a></h2>
In addition to creating <code>.md5</code> files for uploaded files,
<code>mod_md5</code> also automatically deletes the <code>.md5</code> file
when its file is deleted from a <code>MD5Path</code> directory.

<p>
Users of <code>mod_md5</code> will notice that the configuration directives
changed substantially with the <code>1.0rc1</code> release.  These changes
are necessary in order to support new functionality, such as !
<code>MD5Path</code> negation.  The other new feature in <code>1.0rc1</code>
is better integration with <code><a href="http://www.castaglia.org/proftpd/modules/mod_ifession.html">mod_ifsession</a></code>.  This means that now
<code>mod_md5</code>'s capabilities can be controlled to a finer degree by
using <code>mod_ifsession</code> control contexts (demonstrated below).

<p>
This example shows a typical <code>mod_md5</code> configuration:
<pre>
  &lt;IfModule mod_md5.c&gt;
    MD5Engine on
    MD5Path /var/ftp/public/upload
  &lt;/IfModule&gt;
</pre>

<p>
Another example configuration which allows use of <code>mod_md5</code>
capabilities by users in a special group, using <code>mod_ifsession</code>:
<pre>
  &lt;IfModule mod_md5.c&gt;
    MD5Engine on

    &lt;IfGroup md5ftp&gt;
      MD5Path ~
    &lt;/IfUser&gt;
  &lt;/IfModule&gt;
</pre>

<p>
Note that for <code>mod_md5</code> and <code>mod_ifsession</code> to be
used properly together, <code>mod_ifsession</code> <b>must come after</b>
<code>mod_md5</code> in your <code>--with-modules</code> configure option.

<p>
<hr><br>

Author: <i>$Author: tj $</i><br>
Last Updated: <i>$Date: 2006/12/14 01:59:16 $</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000-2006 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>

